<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Cliente | Consultancy OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Ajuste fino para modais */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#F4F7F6]">

    <aside class="w-64 brand-gradient text-white flex flex-col shadow-2xl z-20 hidden md:flex">
        <div class="p-6 flex items-center gap-3 border-b border-white/10">
            <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-[#182B45] font-bold text-xl">M</div>
            <div>
                <h1 class="font-bold text-sm tracking-wide">CONSULTANCY OS</h1>
                <p class="text-xs text-cyan-300">Muoviti Portal</p>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="sidebarNav">
            <button onclick="loadView('home')" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium">
                <i class="fa-solid fa-chart-pie w-5"></i> Visão Geral
            </button>
            <button onclick="loadView('processos')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-diagram-project w-5"></i> Processos
            </button>
            <button onclick="loadView('recrutamento')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-user-group w-5"></i> Recrutamento
            </button>
            <button onclick="loadView('financeiro')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-coins w-5"></i> Financeiro
            </button>
            <button onclick="loadView('diagnostico')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-book-open w-5"></i> Conhecimento
            </button>
            
            <div id="adminMenu" class="hidden mt-6 pt-6 border-t border-white/10">
                <p class="px-4 text-xs font-bold text-cyan-400 uppercase mb-2">Administração</p>
                <button onclick="loadView('admin_clientes')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                    <i class="fa-solid fa-building w-5"></i> Clientes
                </button>
                <button onclick="loadView('admin_usuarios')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-300 hover:text-white">
                    <i class="fa-solid fa-users-gear w-5"></i> Usuários
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10">
            <button onclick="logout()" class="flex items-center gap-2 text-xs text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-right-from-bracket"></i> Sair do Sistema
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col w-full relative">
        <header class="bg-white h-16 border-b px-8 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-gray-600"><i class="fa-solid fa-bars"></i></button>
                <h2 id="pageTitle" class="text-xl font-bold text-[#182B45]">Visão Geral</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p id="userName" class="text-sm font-bold text-gray-700">...</p>
                    <p id="userRole" class="text-xs text-[#00A3A8] font-bold uppercase">...</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-gray-200 border-2 border-[#00A3A8] overflow-hidden">
                    <img id="userAvatar" src="" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <div id="appContent" class="flex-1 p-8 overflow-y-auto relative">
            <div class="text-center mt-20">
                <div class="loader mx-auto"></div>
                <p class="text-gray-400 mt-4 text-sm">Conectando ao banco de dados...</p>
            </div>
        </div>
    </main>

    <div id="universalModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-[#182B45]" id="modalTitle">Novo Registro</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">
                        <i class="fa-solid fa-xmark text-gray-500 hover:text-red-500 text-xl"></i>
                    </div>
                </div>

                <form id="dynamicForm" onsubmit="handleFormSubmit(event)">
                    <div id="modalFields" class="my-5 space-y-4">
                        </div>
                    
                    <div class="flex justify-end pt-2 gap-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-100 p-3 rounded-lg text-gray-600 hover:bg-gray-200 font-bold">Cancelar</button>
                        <button type="submit" id="modalSubmitBtn" class="px-4 py-2 bg-[#00A3A8] p-3 rounded-lg text-white hover:bg-[#008589] font-bold">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÕES
        // ATENÇÃO: Verifique se sua URL termina em /exec
        const API_URL = 'https://script.google.com/macros/s/AKfycbzdpqmplMRsbEzBvCPcm4A9-QyXjsjM2V9eHJ7PtviOkHsEFOSGeoY07WIIWQAw3KU5lw/exec'; 
        
        let currentUser = null;
        let currentTable = null; // Para saber onde salvar

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const session = localStorage.getItem('muoviti_user');
            if (!session) { window.location.href = 'index.html'; return; }
            
            currentUser = JSON.parse(session);
            setupUI();
            loadView('home');
        });

        function setupUI() {
            document.getElementById('userName').innerText = currentUser.nome;
            document.getElementById('userRole').innerText = currentUser.nivel;
            document.getElementById('userAvatar').src = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.nome}&background=00A3A8&color=fff`;

            // Mostra menu Admin se for Admin
            if(currentUser.nivel === 'ADMIN') {
                document.getElementById('adminMenu').classList.remove('hidden');
            }
        }

        function loadView(viewName) {
            // Atualiza Sidebar
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active', 'text-white', 'bg-white/10'));
            // (Opcional: lógica para adicionar active class no botão clicado)

            const content = document.getElementById('appContent');
            const title = document.getElementById('pageTitle');
            content.innerHTML = '<div class="loader mx-auto mt-10"></div>';

            switch(viewName) {
                case 'home':
                    title.innerText = "Dashboard Geral";
                    renderHome(content);
                    break;
                case 'processos':
                    title.innerText = "Gestão de Processos (BPM)";
                    renderProcessos(content);
                    break;
                case 'financeiro':
                    title.innerText = "Gestão Financeira";
                    renderFinanceiro(content);
                    break;
                case 'recrutamento':
                    title.innerText = "Recrutamento & Seleção";
                    renderRecrutamento(content);
                    break;
                case 'diagnostico':
                    title.innerText = "Base de Conhecimento";
                    renderDiagnostico(content);
                    break;
                case 'admin_clientes':
                    title.innerText = "Admin: Clientes";
                    renderAdminClientes(content);
                    break;
                case 'admin_usuarios':
                    title.innerText = "Admin: Usuários";
                    renderAdminUsuarios(content);
                    break;
            }
        }

        // --- RENDERIZADORES ---

        async function renderHome(container) {
            // Se for admin sem cliente vinculado, mostra visão geral diferente
            if(currentUser.nivel === 'ADMIN' && !currentUser.idCliente) {
                container.innerHTML = `<div class="p-8 text-center"><h2 class="text-2xl font-bold text-[#182B45]">Bem-vindo, Admin!</h2><p class="text-gray-500">Selecione um módulo no menu ou gerencie cadastros.</p></div>`;
                return;
            }
            // Lógica normal de cliente (igual anterior, simplificado aqui)
            container.innerHTML = `<div class="text-center text-gray-500 mt-10">Carregando indicadores do cliente ${currentUser.idCliente}...</div>`;
            // Aqui você pode copiar a lógica do dashboard.html anterior
        }

        async function renderProcessos(container) {
            currentTable = 'Processos';
            const data = await fetchData('Processos');
            
            let html = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Processos')" class="bg-[#00A3A8] text-white px-4 py-2 rounded-lg font-bold hover:bg-[#008589]"><i class="fa-solid fa-plus"></i> Novo Processo</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            `;

            if(data.length === 0) html += `<p class="text-gray-500 col-span-3 text-center">Nenhum processo mapeado ainda.</p>`;

            data.forEach(p => {
                let statusColor = 'bg-gray-100 text-gray-600';
                if(p.Status_Implementacao === 'Concluído') statusColor = 'bg-green-100 text-green-700';
                if(p.Status_Implementacao === 'Operação Assistida') statusColor = 'bg-blue-100 text-blue-700';
                if(p.Status_Implementacao === 'Mapeamento') statusColor = 'bg-yellow-100 text-yellow-700';

                html += `
                    <div class="glass-panel p-5 border-l-4 border-[#00A3A8] hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-[#182B45] text-lg">${p.Nome_Processo}</h3>
                            <span class="text-xs font-bold px-2 py-1 rounded ${statusColor}">${p.Status_Implementacao}</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4"><i class="fa-solid fa-layer-group"></i> ${p.Area}</p>
                        ${p.Link_Fluxograma ? `<a href="${p.Link_Fluxograma}" target="_blank" class="text-[#00A3A8] text-sm font-bold hover:underline"><i class="fa-solid fa-link"></i> Ver Fluxograma</a>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html + '</div>';
        }

        async function renderFinanceiro(container) {
            currentTable = 'Financeiro_Macro';
            const data = await fetchData('Financeiro_Macro');
            
            // Cálculos Rápidos
            const total = data.reduce((acc, curr) => acc + (parseFloat(curr.Valor) || 0), 0);
            
            container.innerHTML = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Financeiro')" class="bg-[#00A3A8] text-white px-4 py-2 rounded-lg font-bold hover:bg-[#008589]"><i class="fa-solid fa-plus"></i> Lançar Valor</button>
                    <div class="bg-white px-4 py-2 rounded border font-bold text-[#182B45]">Total Acumulado: R$ ${total.toFixed(2)}</div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-[#182B45] mb-4">Registros Recentes</h4>
                        <div class="overflow-y-auto max-h-64 space-y-3">
                            ${data.map(f => `
                                <div class="flex justify-between border-b pb-2">
                                    <div><p class="font-bold text-gray-700">${f.Descricao}</p><span class="text-xs text-gray-400">${f.Tipo} - ${f.Mes_Referencia}</span></div>
                                    <div class="font-bold text-[#00A3A8]">R$ ${f.Valor}</div>
                                </div>
                            `).join('') || '<p class="text-gray-400">Sem dados.</p>'}
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-[#182B45] mb-4">Visão Gráfica</h4>
                        <canvas id="finChart"></canvas>
                    </div>
                </div>
            `;

            // Render Chart
            new Chart(document.getElementById('finChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.Descricao),
                    datasets: [{ label: 'Valores (R$)', data: data.map(d => d.Valor), backgroundColor: '#00A3A8' }]
                }
            });
        }

        async function renderDiagnostico(container) {
            currentTable = 'Diagnosticos';
            const data = await fetchData('Diagnosticos');
            
            let html = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Diagnosticos')" class="bg-[#00A3A8] text-white px-4 py-2 rounded-lg font-bold hover:bg-[#008589]"><i class="fa-solid fa-plus"></i> Nova Nota</button>
                </div>
                <div class="space-y-4">
            `;
            
            data.forEach(d => {
                html += `
                    <div class="glass-panel p-5 cursor-pointer hover:border-[#00A3A8] transition">
                        <div class="flex justify-between">
                            <h3 class="font-bold text-[#182B45]"><i class="fa-solid fa-file-lines text-gray-400 mr-2"></i>${d.Titulo}</h3>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${d.Categoria}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 line-clamp-2">${d.Descricao_Detalhada}</p>
                    </div>
                `;
            });
            container.innerHTML = html + '</div>';
        }

        async function renderRecrutamento(container) {
            currentTable = 'Recrutamento';
            const data = await fetchData('Recrutamento');
            
            let html = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Recrutamento')" class="bg-[#00A3A8] text-white px-4 py-2 rounded-lg font-bold hover:bg-[#008589]"><i class="fa-solid fa-plus"></i> Novo Candidato</button>
                </div>
                <div class="overflow-x-auto glass-panel">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-600 font-bold uppercase text-xs border-b">
                            <tr><th class="p-4">Candidato</th><th class="p-4">Vaga</th><th class="p-4">Fase</th><th class="p-4">Link</th></tr>
                        </thead>
                        <tbody>
            `;
            data.forEach(c => {
                 html += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold text-[#182B45]">${c.Nome_Candidato}</td>
                    <td class="p-4">${c.Vaga}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${c.Fase_Funil}</span></td>
                    <td class="p-4">${c.Link_Curriculo ? `<a href="${c.Link_Curriculo}" target="_blank" class="text-[#00A3A8] hover:underline">CV</a>` : '-'}</td>
                 </tr>`;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        // --- ADMIN RENDER ---
        async function renderAdminClientes(container) {
            currentTable = 'Clientes';
            const data = await fetchData('Clientes');
            
            let html = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Clientes')" class="bg-[#182B45] text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700"><i class="fa-solid fa-plus"></i> Cadastrar Empresa</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            data.forEach(c => {
                html += `
                    <div class="glass-panel p-4 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">${c.Nome_Empresa}</h3>
                            <p class="text-xs text-gray-400">ID: ${c.ID_Cliente}</p>
                        </div>
                        <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">${c.Status_Projeto}</span>
                    </div>
                `;
            });
            container.innerHTML = html + '</div>';
        }

        async function renderAdminUsuarios(container) {
            currentTable = 'Usuarios';
            const data = await fetchData('Usuarios'); // Nota: Backend precisa permitir ler Usuarios se for Admin
            
            let html = `
                <div class="flex justify-between mb-6">
                    <button onclick="openModal('Usuarios')" class="bg-[#182B45] text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700"><i class="fa-solid fa-plus"></i> Novo Usuário</button>
                </div>
                <div class="overflow-x-auto glass-panel">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-600 font-bold uppercase text-xs border-b">
                            <tr><th class="p-4">Nome</th><th class="p-4">Email (Login)</th><th class="p-4">Nível</th><th class="p-4">Cliente Vinculado</th></tr>
                        </thead>
                        <tbody>
            `;
            data.forEach(u => {
                html += `<tr class="border-b">
                    <td class="p-4 font-bold">${u.Nome}</td>
                    <td class="p-4">${u.Email}</td>
                    <td class="p-4">${u.Nivel}</td>
                    <td class="p-4">${u.ID_Cliente_Vinculado || '-'}</td>
                </tr>`;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        // --- SISTEMA DE MODAIS E FORMULÁRIOS ---
        
        function openModal(type) {
            currentTable = type;
            const modal = document.getElementById('universalModal');
            const title = document.getElementById('modalTitle');
            const fields = document.getElementById('modalFields');
            const body = document.querySelector('body');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            body.classList.add('modal-active');
            
            // Gerador de Formulários Dinâmico
            let formHtml = '';
            
            if(type === 'Processos') {
                title.innerText = "Novo Processo";
                formHtml = `
                    <input type="text" name="Nome_Processo" placeholder="Nome do Processo" class="w-full p-3 border rounded" required>
                    <input type="text" name="Area" placeholder="Área (Ex: Financeiro)" class="w-full p-3 border rounded">
                    <select name="Status_Implementacao" class="w-full p-3 border rounded bg-white">
                        <option>Mapeamento</option><option>Validação</option><option>Treinamento</option><option>Operação Assistida</option><option>Concluído</option>
                    </select>
                    <input type="text" name="Link_Fluxograma" placeholder="URL do Fluxograma (Opcional)" class="w-full p-3 border rounded">
                `;
            } else if (type === 'Financeiro') {
                title.innerText = "Lançamento Financeiro";
                formHtml = `
                    <input type="text" name="Descricao" placeholder="Descrição (Ex: Economia Mês)" class="w-full p-3 border rounded" required>
                    <input type="number" name="Valor" placeholder="Valor (Ex: 1500.00)" class="w-full p-3 border rounded" required>
                    <select name="Tipo" class="w-full p-3 border rounded bg-white"><option>Economia Gerada</option><option>Investimento</option><option>Faturamento</option></select>
                    <input type="text" name="Mes_Referencia" placeholder="Mês (Ex: Jan/2026)" class="w-full p-3 border rounded">
                `;
            } else if (type === 'Recrutamento') {
                title.innerText = "Cadastrar Candidato";
                formHtml = `
                    <input type="text" name="Nome_Candidato" placeholder="Nome Completo" class="w-full p-3 border rounded" required>
                    <input type="text" name="Vaga" placeholder="Vaga (Ex: Gerente)" class="w-full p-3 border rounded">
                    <select name="Fase_Funil" class="w-full p-3 border rounded bg-white"><option>Captado</option><option>Entrevista</option><option>Teste Técnico</option><option>Aprovado</option></select>
                    <input type="text" name="Link_Curriculo" placeholder="Link do LinkedIn/CV" class="w-full p-3 border rounded">
                `;
            } else if (type === 'Diagnosticos') {
                title.innerText = "Novo Diagnóstico";
                formHtml = `
                    <input type="text" name="Titulo" placeholder="Título da Nota" class="w-full p-3 border rounded" required>
                    <select name="Categoria" class="w-full p-3 border rounded bg-white"><option>Entrevista</option><option>GAP</option><option>Oportunidade</option></select>
                    <textarea name="Descricao_Detalhada" rows="4" placeholder="Detalhes..." class="w-full p-3 border rounded"></textarea>
                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="Visivel_Cliente" value="TRUE"> Visível para o Cliente?</label>
                `;
            } else if (type === 'Clientes') {
                title.innerText = "Novo Cliente";
                formHtml = `
                    <input type="text" name="ID_Cliente" placeholder="ID Único (Ex: CLI-001)" class="w-full p-3 border rounded uppercase" required>
                    <input type="text" name="Nome_Empresa" placeholder="Nome da Empresa" class="w-full p-3 border rounded" required>
                    <select name="Status_Projeto" class="w-full p-3 border rounded bg-white"><option>Onboarding</option><option>Em Andamento</option><option>Concluído</option></select>
                `;
            } else if (type === 'Usuarios') {
                title.innerText = "Novo Usuário";
                formHtml = `
                    <input type="text" name="Nome" placeholder="Nome do Usuário" class="w-full p-3 border rounded" required>
                    <input type="email" name="Email" placeholder="Login (E-mail)" class="w-full p-3 border rounded" required>
                    <input type="text" name="Senha" placeholder="Senha" class="w-full p-3 border rounded" required>
                    <select name="Nivel" class="w-full p-3 border rounded bg-white"><option>CLIENTE</option><option>CONSULTOR</option><option>ADMIN</option></select>
                    <input type="text" name="ID_Cliente_Vinculado" placeholder="ID do Cliente Vinculado (Se for Cliente)" class="w-full p-3 border rounded uppercase">
                `;
            }

            fields.innerHTML = formHtml;
        }

        function closeModal() {
            const modal = document.getElementById('universalModal');
            const body = document.querySelector('body');
            modal.classList.add('opacity-0', 'pointer-events-none');
            body.classList.remove('modal-active');
        }

        // --- INTEGRAÇÃO API (CRUD) ---
        
        async function fetchData(table) {
            try {
                // Se for Usuarios, não mandamos filtro de cliente, pois admin vê tudo
                const idFilter = (table === 'Usuarios' || table === 'Clientes') ? '' : currentUser.idCliente;
                
                const res = await fetch(`${API_URL}?action=readAll&table=${table}&userLevel=${currentUser.nivel}&userIdClient=${idFilter}`);
                const json = await res.json();
                return json.data || [];
            } catch(e) {
                console.error(e);
                return [];
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('modalSubmitBtn');
            btn.innerHTML = 'Salvando...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const payload = {};
            formData.forEach((value, key) => payload[key] = value);

            // Injeta ID do Cliente automaticamente se não for Admin criando cadastro global
            if(currentUser.nivel !== 'ADMIN' || (currentTable !== 'Clientes' && currentTable !== 'Usuarios')) {
                payload['ID_Cliente'] = currentUser.idCliente;
            }
            // Autor para diagnósticos
            if(currentTable === 'Diagnosticos') payload['Autor'] = currentUser.nome;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        action: 'create',
                        table: currentTable,
                        payload: payload
                    })
                });
                
                closeModal();
                loadView(currentTable === 'Financeiro_Macro' ? 'financeiro' : currentTable.toLowerCase()); // Refresh
                alert("Salvo com sucesso!");

            } catch(err) {
                alert("Erro ao salvar: " + err.message);
            } finally {
                btn.innerHTML = 'Salvar';
                btn.disabled = false;
            }
        }

        function logout() {
            if(confirm("Sair?")) {
                localStorage.removeItem('muoviti_user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
